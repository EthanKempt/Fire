<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Targets</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
      crossorigin="anonymous"
    ></script>
    <script src="/src/site.js"></script>
    <script src="bundle.js"></script>
    <script src="bundleTeams.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand">Higley</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="home.html" aria-current="page">Home</a>
            <a class="nav-link" href="teams.html">Teams</a>
            <a class="nav-link active" href="targets.html">Targets</a>
            <a class="nav-link" href="rules.html">Rules</a>

            <button
              type="button"
              id="logout"
              onclick="logout()"
              class="btn btn-primary me-auto loginButton"
              data-bs-toggle="modal"
              data-bs-target="#loginModal"
            >
              Log Out
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container column text-center">
      <div class="row align-items-middle">
        <div class="col col-2 left-side"></div>
        <div class="col">
          <br />
          <p class="fs-5">
            Your team <b id="not"></b> gotten someone out this week meaning you
            are <b id="safer"></b>. Your assigned team is
            <b id="target"></b> and the people on the team are:
          </p>
          <br />
          <div class="card-header">
            <p class="fs-4" id="teamTitle">Team Name</p>
          </div>
          <ul class="list-group list-group-flush" id="list">
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              id="player1"
            >
              <span class="badge bg-primary rounded-pill">In</span>
            </li>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              id="player2"
            >
              <span class="badge bg-primary rounded-pill">In</span>
            </li>
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              id="player3"
            >
              <span class="badge bg-primary rounded-pill">In</span>
            </li>
          </ul>
        </div>
        <div class="col message-col">
          <br />

          <div class="card text-bg-light mb-3 message-display text-start">
            <div class="card-header message-header">Admin</div>
            <div
              class="card-body message-body overflow-auto"
              id="messager"
            ></div>
          </div>
          <div class="input-group mb-3">
            <input
              type="text"
              class="form-control"
              placeholder="your message"
              aria-describedby="button-addon2"
              id="messageVal"
            />
            <button
              class="btn btn-outline-primary"
              type="button"
              id="button-addon2"
              onclick="sendMessage()"
            >
              Send
            </button>
          </div>
        </div>
        <div class="col col-2 right-side"></div>
      </div>
    </div>
  </body>
</html>

<script>
  var infill = document.getElementById("not");
  var infill2 = document.getElementById("safer");
  var infill3 = document.getElementById("target");
  var infill4 = document.getElementById("teamTitle");
  var team = sessionStorage.currentTeam;
  var teams = updateTeams;
  for (let i = 0; i < teams.length; i++) {
    if (team == teams[i].teamName) {
      if (teams[i].safe) {
        infill.innerHTML = "has";
        infill2.innerHTML = "safe";
      } else {
        infill.innerHTML = "has not";
        infill2.innerHTML = "not safe";
      }
      if (team == teams[i].teamName) {
        var target = teams[i].targets;
        infill3.innerHTML = target;
        infill4.innerHTML = target;
      }
      for (let x = 0; x < teams.length; x++) {
        if (target == teams[x].teamName) {
          var target1 = teams[x].player1;
          var target2 = teams[x].player2;
          var target3 = teams[x].player3;
          player1.innerHTML = target1;
          if (checkIn(target1)) {
            var ele = document.getElementById("player1");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>In</span>";
          } else {
            var ele = document.getElementById("player1");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>Out</span>";
          }
          player2.innerHTML = target2;
          if (checkIn(target2)) {
            var ele = document.getElementById("player2");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>In</span>";
          } else {
            var ele = document.getElementById("player2");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>Out</span>";
          }
          player3.innerHTML = target3;
          if (checkIn(target3)) {
            var ele = document.getElementById("player3");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>In</span>";
          } else {
            var ele = document.getElementById("player3");
            ele.innerHTML +=
              "<span class='badge bg-primary rounded-pill'>Out</span>";
          }
          if (teams[x].player4) {
            var list = document.getElementById("list");
            list.innerHTML +=
              "<li class='list-group-item d-flex justify-content-between align-items-center' id='player4'> <span class='badge bg-primary rounded-pill'>In</span> </li>";
            var target4 = teams[x].player4;
            player4.innerHTML = target4;
            if (checkIn(target4)) {
              var ele = document.getElementById("player4");
              ele.innerHTML +=
                "<span class='badge bg-primary rounded-pill'>In</span>";
            } else {
              var ele = document.getElementById("player4");
              ele.innerHTML +=
                "<span class='badge bg-primary rounded-pill'>Out</span>";
            }
          }
          function checkIn(a) {
            //var names = JSON.parse(sessionStorage.names);
            for (let y = 0; y < names.length; y++) {
              var userIn = names[y].name;
              if (a == userIn) {
                if (names[y].status) {
                  return true;
                } else {
                  return false;
                }
              }
            }
          }
        }
      }
    }
  }

  function scrollBottom() {
    let messageBox = document.getElementById("messager");
    messageBox.scrollTop = messageBox.scrollHeight;
  }

  initMessages();
  async function initMessages() {
    var messagesArray = await messageUpdate;
    var sorted = messagesArray.sort((a, b) => a.time.seconds - b.time.seconds);
    var messageBox = document.getElementById("messager");
    var done = true;

    for (let a = 0; a < sorted.length; a++) {
      if (sorted.length > 20 && done) {
        a = sorted.length - 20;
        var done = false;
        window.firstMessage = sorted[a];
      }
      let message = sorted[a].value;
      var color = "primary";
      if (sorted[a].author == "admin") {
        color = "secondary";
      }
      messageBox.innerHTML +=
        '<h4><div class="badge bg-' +
        color +
        ' message">' +
        message +
        "</div></h4>";
    }
    scrollBottom();
  }

  function sendMessage() {
    var team = sessionStorage.currentTeam;
    let auth = "team";
    let val = document.getElementById("messageVal").value;
    addMessage(team, auth, val); //teamName + author + value
  }

  var messageBox = document.getElementById("messager");
  messageBox.addEventListener("scroll", (event) => {
    initUserMessages();
  });

  async function initUserMessages() {
    var totalMessages = await updateMessages;
    var messageBox = document.getElementById("messager");
    if (messageBox.scrollTop == 0 && messageBox.childElementCount != allSize) {
      var keep = messageBox.firstElementChild;
      var sorted = totalMessages.sort(
        (a, b) => a.time.seconds - b.time.seconds
      );
      for (let c = 0; c < 20; c++) {
        sorted.sort((a, b) => a.time.seconds - b.time.seconds);
        sorted.pop();
      }
      let short = sorted;
      var amountToLoad = 20;
      if (short.length < 20) {
        amountToLoad = short.length;
      }
      for (let b = 0; b < amountToLoad; b++) {
        var fullMessage = short.pop();
        if (b == amountToLoad - 2) {
          window.firstMessage = fullMessage;
        }
        var color = "primary";
        if (fullMessage.author == "admin") {
          color = "secondary";
        }
        let message = fullMessage.value;
        let currentMessage =
          '<h4><div class="badge bg-' +
          color +
          ' message">' +
          message +
          "</div></h4>";
        messageBox.insertAdjacentHTML("afterbegin", currentMessage);
      }
      keep.scrollIntoView();
    }
  }
</script>

<style>
  .navbar {
    background-color: #2e4b73 !important;
    height: 9vh;
  }
  .navbar-brand {
    color: white;
  }
  .navbar-brand:hover {
    color: white !important;
  }
  .nav-link {
    color: #c0c0c0;
  }
  .nav-link.active {
    color: white !important;
  }
  .navbar-toggler {
    border-color: white;
    border-width: 2px;
  }

  .container {
    margin-left: 0px;
    margin-right: 0px;
  }
  .display-1 {
    font-weight: 500;
  }
  .h5 {
    margin-top: 15px;
    margin-bottom: 0px;
  }
  .left-side {
    background-color: #8b8b8b;
    min-height: 91vh;
  }
  .right-side {
    background-color: #8b8b8b;
    min-height: 91vh;
  }
  .row {
    width: 100vw;
  }
  .view-box {
    height: 50vh;
  }
  .loginButton {
    position: absolute;
    right: 1vw;
  }
  @media (max-width: 991px) {
    .right-side {
      display: none;
    }
    .left-side {
      display: none;
    }
    #logout {
      margin-top: 15px;
    }
  }
  .message-display {
    max-width: 100%;
    height: 18rem;
  }
  .message-header {
    font-weight: 700;
  }
  .message-col {
    max-width: 33.33%;
  }
  .message {
    max-width: 100%;
    white-space: normal;
    text-align: left;
  }
</style>
